@Library  ('shared-lib') _
pipeline {
    agent {label 'agent-1'}
    environment {
        IMAGE_NAME = 'anas587/kubernets-app-app'
        DOCKERHUB_CRED = 'DockerHub'
        K8S_TOKEN = 'ServiceAccount-Token'
        K8S_SERVER = 'API Server'
        NAMESPACE = "${env.BRANCH_NAME}"
        DEPLOYMENT_FILE = "${env.BRANCH_NAME}-deployment.yaml"
        WORK_DIR = 'jenkins-ci-cd/lab-24/Jenkins_App'
    }
    stages {
        stage('Build and Test') {
            steps {
                dir("${WORK_DIR}") {
                    buildApp()
                }
            }
        }
        stage('Docker Build and Push') {
            steps {
                dir("${WORK_DIR}") {
                    buildAndpushImage(IMAGE_NAME, DOCKERHUB_CRED)
                }
            }
        }
        stage('Deploy') {
            steps {
                dir("${WORK_DIR}") {
                    deployToK8sMultibranch(IMAGE_NAME, DEPLOYMENT_FILE, NAMESPACE, K8S_SERVER, K8S_TOKEN)
                }
            }
        }
    }
    
    post {
        always {
            echo 'Pipeline execution completed'
            sh 'docker logout || true'
        }
        success {
            echo 'Pipeline executed successfully!'
        }
        failure {
            echo 'Pipeline execution failed!'
        }
    }
}
